# Описание

## Архитектура кода

В данном проекте была использована трехслойная архитектура, разделяющая код на слои: работа с данными, бизнес-логика и слой представления.

## Выбор репозитория

В качестве репозитория были выбраны две реализации: в памяти и в postgresql.

### В памяти

В этом варианте блокировка документа от параллельной обработки достигается с помощью Mutex на каждый документ. Так как репозиторий находится в памяти, распараллелить обработку документов между разными хостами невозможно. Можно распараллелить обработку документов только с помощью горутин (вертикальное масштабирование).

### Postgres

В этом варианте блокировка документа от параллельной обработки достигается с помощью pg_advisory блокировок по url документа. Так как у нас общее хранилище БД, все хосты синхронизируются в одном месте (горизонтальное масштабирование).

## Интерфейсы

Работа с данными и бизнес-логика описана интерфейсами.

## Тесты

Основной код (работа с данными и бизнес-логика) покрыт юнит-тестами.

## Kafka

Чтобы сэмулировать продовую ситуацию, когда поступают сообщения, была добавлена Kafka. Так как Kafka не основное задание, тестов на это нет.
Посмотреть топики и сообщении в Kafka можно в UI в браузере по адресу: `localhost:8085`.

## Переменные окружения

Большинство параметров таких как логины, пароли, порты, и др были вынесены в `.env` файл. В коде читаем его в `Config` структуру, которая используется везде.

## Масштабирование и синхронизация

Есть две реализации слоя работы с данными, которые позволяют по-разному синхронизироваться и масштабироваться.

Если использовать хранилище в памяти `InMemoryRepository`, то синхранизация происходит только в рамках одного хоста, поэтому масштабироваться можно только вверх по ресурсам, увеличивая число горутин.

Если использовать хранилище PostgreSQL `PostgresRepository`, то синхронизация будет происходить по всем хостам, так как единое хранилище, поэтому масштабироваться можно горизонтально, увеличивая число хостов.

# Usage

## Создать .env

```bash
make env
```

## Тестирование

```bash
make test
```

## Поднять окружение

```bash
make docker-up
```

## Запустить сервис (обработку сообщений)

```bash
make start
```

## Отправить сообщение в Kafka

```bash
make message
```

## Удалить окружение

```bash
make docker-down
```

## Миграции БД

```bash
make migrate-up
make migrate-down
```

## Сгенерировать Go-файлы по Proto

```bash
make proto-to-golang
```
